Bootstrap: docker
From: provarepro/openvino:2021.1pre_c-python-3.6

%post
    export DEBIAN_FRONTEND=noninteractive
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export LANGUAGE=C.UTF-8
    export PYTHON_VERSION="3.6"

    cd /
    git clone https://github.com/gflags/gflags.git
    cd gflags
    mkdir build && cd build
    cmake ..
    make

    cd /
    apt-get update
    apt-get install -y --no-install-recommends \
        libicu-dev \
        libbz2-dev \
        liblzma-dev
    rm -rf /var/lib/apt/lists/*

    export BOOST_VERSION="1.72.0"
    export _BOOST_VERSION="1_72_0"

    wget -q https://dl.bintray.com/boostorg/release/${BOOST_VERSION}/source/boost_${_BOOST_VERSION}.tar.gz
    tar xf boost_${_BOOST_VERSION}.tar.gz
    cd boost_${_BOOST_VERSION}
    ./bootstrap.sh --with-libraries=filesystem
    ./b2 --with-filesystem

    cd /
    python${PYTHON_VERSION} -m pip install \
    pybind11 absl-py
    git clone \
        --depth 1 \
        --single-branch \
        -b v0.7 \
        https://github.com/mlperf/inference.git /mlperf_inference
    cd /mlperf_inference
    mkdir loadgen/build
    cd loadgen/build
    cmake ..
    cmake --build .
    cp libmlperf_loadgen.a ..
    rm -r /mlperf_inference/loadgen/build
    cp -r /mlperf_inference/loadgen /mlperf_loadgen
    rm -rf /mlperf_inference

    export gflags_DIR=/gflags/build
    export InferenceEngine_DIR=/openvino/build

    cd /
    git clone https://github.com/mlperf/inference_results_v0.7.git
    mv inference_results_v0.7/closed/Intel/code/resnet/resnet-ov /mlperf_inference
    rm -rf inference_results_v0.7
    cd /mlperf_inference
    mkdir build && cd build
    cmake \
        -DLOADGEN_DIR=/mlperf_loadgen \
        -DBOOST_INCLUDE_DIRS=/boost_${_BOOST_VERSION} \
        -DBOOST_FILESYSTEM_LIB=/boost_${_BOOST_VERSION}/stage/lib/libboost_filesystem.so \
        -DCMAKE_BUILD_TYPE=Release \
        ..
    cmake --build . --config Release

%environment
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export LANGUAGE=C.UTF-8
    export LOADGEN_LIB_DIR=/mlperf_loadgen
    export PYTHON_VERSION="3.6"
