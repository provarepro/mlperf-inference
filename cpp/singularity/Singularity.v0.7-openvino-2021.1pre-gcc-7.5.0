Bootstrap: docker
From: ubuntu:18.04

%post
    export DEBIAN_FRONTEND=noninteractive
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export LANGUAGE=C.UTF-8
    export OPENCV_VERSION="4.3.0"
    export CMAKE_VERSION="3.17.2"
    export PYTHON_VERSION="3.6"

    cd /
    apt-get update
    apt-get install -y --no-install-recommends \
        git \
        ca-certificates \
        sudo \
        python${PYTHON_VERSION}-dev
    rm -rf /var/lib/apt/lists/*

    git clone \
        --depth 1 \
        --single-branch \
        -b releases/2021/1.pre \
        https://github.com/openvinotoolkit/openvino.git
    cd /openvino
    git submodule update --init --recursive
    ./install_dependencies.sh

    apt-get purge -y cmake
    rm -rf /var/lib/apt/lists/*
    cd /usr/bin/ && rm python
    ln -s python3 python

    cd /
    curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
    python${PYTHON_VERSION} get-pip.py
    python${PYTHON_VERSION} -m pip install \
        numpy \
        cython \
        cmake==${CMAKE_VERSION}
    wget -q https://github.com/opencv/opencv/archive/${OPENCV_VERSION}.zip
    unzip -q ${OPENCV_VERSION}.zip
    cd /opencv-${OPENCV_VERSION}
    mkdir build && cd build
    cmake \
        -DPYTHON_EXECUTABLE=/usr/bin/python${PYTHON_VERSION} \
        -DPYTHON3_LIBRARY=/usr/lib/x86_64-linux-gnu/libpython${PYTHON_VERSION}m.so \
        -DPYTHON3_INCLUDE_DIR=/usr/include/python${PYTHON_VERSION} \
        -DCMAKE_INSTALL_PREFIX=/opt/opencv \
        ..
    cmake --build .
    make install
    export OpenCV_DIR=/opt/opencv/lib/cmake/opencv4

    cd /openvino
    mkdir build && cd build
    cmake \
        -DCMAKE_BUILD_TYPE=Release \
        -DENABLE_PYTHON=ON \
        -DPYTHON_EXECUTABLE=/usr/bin/python${PYTHON_VERSION} \
        -DPYTHON_LIBRARY=/usr/lib/x86_64-linux-gnu/libpython${PYTHON_VERSION}m.so \
        -DPYTHON_INCLUDE_DIR=/usr/include/python${PYTHON_VERSION} \
        -DENABLE_OPENCV=OFF \
        -DENABLE_VPU=OFF \
        -DENABLE_CLDNN=OFF \
        -DENABLE_GNA=OFF \
        -DENABLE_TESTS=OFF \
        -DTHREADING=OMP \
        **-DNGRAPH_ONNX_IMPORT_ENABLE=OFF \
        -DNGRAPH_DEPRECATED_ENABLE=FALSE** \
        ..
    make --jobs=$(nproc --all)

    cd /
    git clone https://github.com/gflags/gflags.git
    cd gflags
    mkdir build && cd build
    cmake ..
    make

    cd /
    apt-get update
    apt-get install -y --no-install-recommends \
        libicu-dev \
        libbz2-dev \
        liblzma-dev
    rm -rf /var/lib/apt/lists/*

    export BOOST_VERSION="1.72.0"
    export _BOOST_VERSION="1_72_0"

    wget -q https://dl.bintray.com/boostorg/release/${BOOST_VERSION}/source/boost_${_BOOST_VERSION}.tar.gz
    tar xf boost_${_BOOST_VERSION}.tar.gz
    cd boost_${_BOOST_VERSION}
    ./bootstrap.sh --with-libraries=filesystem
    ./b2 --with-filesystem

    cd /
    python${PYTHON_VERSION} -m pip install \
    pybind11 absl-py
    git clone \
        --depth 1 \
        --single-branch \
        -b v0.7 \
        https://github.com/mlperf/inference.git /mlperf_inference
    cd /mlperf_inference
    mkdir loadgen/build
    cd loadgen/build
    cmake ..
    cmake --build .
    cp libmlperf_loadgen.a ..
    rm -r /mlperf_inference/loadgen/build
    cp -r /mlperf_inference/loadgen /mlperf_loadgen
    rm -rf /mlperf_inference

    export gflags_DIR=/gflags/build
    export InferenceEngine_DIR=/openvino/build

    cd /
    git clone https://github.com/mlperf/inference_results_v0.7.git
    cd inference_results_v0.7/closed/Intel/code/resnet/resnet-ov/
    mkdir build && cd build
    cmake \
        -DLOADGEN_DIR=/mlperf_loadgen \
        -DBOOST_INCLUDE_DIRS=/boost_1_72_0 \
        -DBOOST_FILESYSTEM_LIB=/boost_1_72_0/stage/lib/libboost_filesystem.so \
        -DCMAKE_BUILD_TYPE=Release \
        ..
    cmake --build . --config Release

%environment
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export LANGUAGE=C.UTF-8
    export LOADGEN_LIB_DIR=/mlperf_loadgen
    export OPENCV_VERSION="4.3.0"
    export CMAKE_VERSION="3.17.2"
    export PYTHON_VERSION="3.6"
